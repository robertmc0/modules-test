{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.13.1.58284",
      "templateHash": "596735136395090398"
    }
  },
  "parameters": {
    "emailAddress": {
      "type": "string",
      "metadata": {
        "description": "Email address which will get notifications from Microsoft Defender for Cloud by the configurations defined in this security contact."
      }
    },
    "phone": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. The security contact's phone number."
      }
    },
    "alertNotificationSeverity": {
      "type": "string",
      "allowedValues": [
        "High",
        "Medium",
        "Low"
      ],
      "metadata": {
        "description": "Defines the minimal alert severity which will be sent as email notifications."
      }
    },
    "notificationsByRole": {
      "type": "array",
      "defaultValue": [],
      "allowedValues": [
        "AccountAdmin",
        "Contributor",
        "Owner",
        "ServiceAdmin"
      ],
      "metadata": {
        "description": "Optional. Defines which RBAC roles will get email notifications from Microsoft Defender for Cloud."
      }
    },
    "pricingCloudPosture": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The default pricing tier for Cloud Security Posture Management (CSPM) plan."
      }
    },
    "pricingTierVMs": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Servers."
      }
    },
    "pricingTierSqlServers": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for SQL."
      }
    },
    "pricingTierAppServices": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for App Service."
      }
    },
    "pricingTierStorageAccounts": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Storage."
      }
    },
    "pricingTierSqlServerVirtualMachines": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for SQL VMs."
      }
    },
    "pricingTierOpenSourceRelationalDatabases": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Open Source Relational Databases."
      }
    },
    "pricingTierKubernetesService": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Kubernetes."
      }
    },
    "pricingTierContainerRegistry": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Azure Container Registry."
      }
    },
    "pricingTierContainers": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Containers."
      }
    },
    "pricingTierKeyVaults": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for Key Vaults."
      }
    },
    "pricingTierDns": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for DNS."
      }
    },
    "pricingTierArm": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for ARM."
      }
    },
    "pricingTierCosmosDbs": {
      "type": "string",
      "defaultValue": "Free",
      "allowedValues": [
        "Standard",
        "Free"
      ],
      "metadata": {
        "description": "Optional. The pricing tier for Microsoft Defender for CosmosDbs."
      }
    },
    "workspaceId": {
      "type": "string",
      "metadata": {
        "description": "Resource ID of the Log Analytics workspace."
      }
    },
    "workspaceScope": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]",
      "metadata": {
        "description": "Optional. All the VMs in this scope will send their security data to the mentioned workspace unless overridden by a setting with more specific scope."
      }
    },
    "autoProvision": {
      "type": "string",
      "defaultValue": "On",
      "allowedValues": [
        "On",
        "Off"
      ],
      "metadata": {
        "description": "Optional. Automatically enable new resources into the log analytics workspace."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Security/securityContacts",
      "apiVersion": "2020-01-01-preview",
      "name": "default",
      "properties": {
        "emails": "[parameters('emailAddress')]",
        "phone": "[if(not(empty(parameters('phone'))), parameters('phone'), null())]",
        "notificationsByRole": "[if(not(empty(parameters('notificationsByRole'))), createObject('roles', parameters('notificationsByRole'), 'state', 'On'), createObject())]",
        "alertNotifications": {
          "minimalSeverity": "[parameters('alertNotificationSeverity')]",
          "state": "On"
        }
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "CloudPosture",
      "properties": {
        "pricingTier": "[parameters('pricingCloudPosture')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "VirtualMachines",
      "properties": {
        "pricingTier": "[parameters('pricingTierVMs')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "SqlServers",
      "properties": {
        "pricingTier": "[parameters('pricingTierSqlServers')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "SqlServerVirtualMachines",
      "properties": {
        "pricingTier": "[parameters('pricingTierSqlServerVirtualMachines')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "OpenSourceRelationalDatabases",
      "properties": {
        "pricingTier": "[parameters('pricingTierOpenSourceRelationalDatabases')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "AppServices",
      "properties": {
        "pricingTier": "[parameters('pricingTierAppServices')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "StorageAccounts",
      "properties": {
        "pricingTier": "[parameters('pricingTierStorageAccounts')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "KubernetesService",
      "properties": {
        "pricingTier": "[parameters('pricingTierKubernetesService')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "ContainerRegistry",
      "properties": {
        "pricingTier": "[parameters('pricingTierContainerRegistry')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "Containers",
      "properties": {
        "pricingTier": "[parameters('pricingTierContainers')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "KeyVaults",
      "properties": {
        "pricingTier": "[parameters('pricingTierKeyVaults')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "Dns",
      "properties": {
        "pricingTier": "[parameters('pricingTierDns')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "Arm",
      "properties": {
        "pricingTier": "[parameters('pricingTierArm')]"
      }
    },
    {
      "type": "Microsoft.Security/pricings",
      "apiVersion": "2022-03-01",
      "name": "CosmosDbs",
      "properties": {
        "pricingTier": "[parameters('pricingTierCosmosDbs')]"
      }
    },
    {
      "type": "Microsoft.Security/workspaceSettings",
      "apiVersion": "2017-08-01-preview",
      "name": "default",
      "properties": {
        "scope": "[format('/subscriptions/{0}', parameters('workspaceScope'))]",
        "workspaceId": "[parameters('workspaceId')]"
      }
    },
    {
      "type": "Microsoft.Security/autoProvisioningSettings",
      "apiVersion": "2017-08-01-preview",
      "name": "default",
      "properties": {
        "autoProvision": "[parameters('autoProvision')]"
      }
    }
  ]
}